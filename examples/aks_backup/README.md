<!-- BEGIN_TF_DOCS -->
<!-- Code generated by terraform-docs. DO NOT EDIT. -->
# AKS Backup Example

This example demonstrates how to deploy an Azure Data Protection Backup Vault with a Kubernetes Backup Policy and Backup Instance configured to protect an Azure Kubernetes Service (AKS) cluster. The configuration includes retention rules, snapshot storage settings, and role assignments required for secure, automated backups of Kubernetes workloads.

```hcl
terraform {
  required_version = ">= 1.7.0"

  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = ">= 3.116.0, < 5.0.0"
    }
    time = {
      source  = "hashicorp/time"
      version = ">= 0.9.1"
    }
  }
}

provider "azurerm" {
  features {}
}

data "azurerm_client_config" "current" {}

module "naming" {
  source  = "Azure/naming/azurerm"
  version = "~> 0.3"

  suffix = ["aks"]
}

# Resource groups
resource "azurerm_resource_group" "example" {
  location = "eastus2"
  name     = module.naming.resource_group.name_unique
}

resource "azurerm_resource_group" "snap" {
  location = azurerm_resource_group.example.location
  name     = "${module.naming.resource_group.name_unique}-snap"
}

# AKS Cluster with System Identity
resource "azurerm_kubernetes_cluster" "example" {
  location            = azurerm_resource_group.example.location
  name                = module.naming.kubernetes_cluster.name_unique
  resource_group_name = azurerm_resource_group.example.name
  dns_prefix          = "aks${substr(module.naming.kubernetes_cluster.name_unique, -6, -1)}"
  sku_tier            = "Standard"

  default_node_pool {
    name                        = "default"
    auto_scaling_enabled        = true
    max_count                   = 9
    min_count                   = 3
    orchestrator_version        = null
    os_disk_type                = "Managed"
    temporary_name_for_rotation = "tempnodepool"
    type                        = "VirtualMachineScaleSets"
    vm_size                     = "Standard_D4s_v3"
    zones                       = ["1", "3"]

    upgrade_settings {
      max_surge                     = "33%"
      drain_timeout_in_minutes      = 15
      node_soak_duration_in_minutes = 15
    }
  }
  identity {
    type = "SystemAssigned"
  }
}


# Storage account required for the AKS extension
resource "azurerm_storage_account" "example" {
  account_replication_type = "ZRS"
  account_tier             = "Standard"
  location                 = azurerm_resource_group.example.location
  name                     = lower(replace("stgaks${substr(module.naming.resource_group.name_unique, -12, -1)}", "-", ""))
  resource_group_name      = azurerm_resource_group.example.name
}

resource "azurerm_storage_container" "example" {
  name                  = "backup"
  container_access_type = "private"
  storage_account_id    = azurerm_storage_account.example.id
}

# Install the Kubernetes Data Protection extension
resource "azurerm_kubernetes_cluster_extension" "backup_extension" {
  cluster_id     = azurerm_kubernetes_cluster.example.id
  extension_type = "Microsoft.DataProtection.Kubernetes"
  name           = "backup-extension"
  configuration_settings = {
    "configuration.backupStorageLocation.bucket"                = azurerm_storage_container.example.name
    "configuration.backupStorageLocation.config.resourceGroup"  = azurerm_resource_group.example.name
    "configuration.backupStorageLocation.config.storageAccount" = azurerm_storage_account.example.name
    "configuration.backupStorageLocation.config.subscriptionId" = data.azurerm_client_config.current.subscription_id
    "credentials.tenantId"                                      = data.azurerm_client_config.current.tenant_id
  }
  release_namespace = "dataprotection-microsoft"
  release_train     = "stable"
}

# Add wait after extension creation
resource "time_sleep" "wait_for_extension" {
  create_duration = "5m" # Allow 5 minutes for extension to initialize

  depends_on = [azurerm_kubernetes_cluster_extension.backup_extension]
}

# Grant the extension access to the storage account
resource "azurerm_role_assignment" "extension_storage_access" {
  principal_id         = azurerm_kubernetes_cluster_extension.backup_extension.aks_assigned_identity[0].principal_id
  scope                = azurerm_storage_account.example.id
  role_definition_name = "Storage Account Contributor"

  depends_on = [time_sleep.wait_for_extension]
}

# Backup vault using the module
module "backup_vault" {
  source = "../../"

  datastore_type      = "VaultStore"
  location            = azurerm_resource_group.example.location
  name                = "${module.naming.recovery_services_vault.name_unique}-vault"
  redundancy          = "LocallyRedundant"
  resource_group_name = azurerm_resource_group.example.name
  # Specify backup datasource parameters
  backup_datasource_parameters = {
    excluded_namespaces              = ["kube-system", "kube-public"]
    included_namespaces              = ["default", "app-namespace"]
    cluster_scoped_resources_enabled = true
    volume_snapshot_enabled          = true
  }
  backup_repeating_time_intervals = ["R/2024-12-01T02:30:00+00:00/P1W"]
  # AKS default retention configuration
  default_retention_life_cycle = {
    data_store_type = "OperationalStore"
    duration        = "P14D"
  }
  enable_telemetry = true
  # AKS backup instance configuration
  kubernetes_backup_instance_name = "${module.naming.kubernetes_cluster.name_unique}-backup-instance"
  # AKS backup policy configuration
  kubernetes_backup_policy_name = "${module.naming.kubernetes_cluster.name_unique}-policy"
  kubernetes_cluster_id         = azurerm_kubernetes_cluster.example.id
  # Additional retention rules
  kubernetes_retention_rules = [
    {
      name              = "Weekly"
      priority          = 25
      absolute_criteria = "FirstOfWeek"
      data_store_type   = "OperationalStore"
      duration          = "P84D"
    },
    {
      name              = "Monthly"
      priority          = 20
      absolute_criteria = "FirstOfMonth"
      data_store_type   = "OperationalStore"
      duration          = "P365D"
    }
  ]
  managed_identities = {
    system_assigned = true
  }
  snapshot_resource_group_name = azurerm_resource_group.snap.name
  time_zone                    = "UTC"

  depends_on = [time_sleep.wait_for_extension]
}

# Create trusted access role binding between AKS and backup vault
resource "azurerm_kubernetes_cluster_trusted_access_role_binding" "backup_access" {
  kubernetes_cluster_id = azurerm_kubernetes_cluster.example.id
  name                  = "backup-operator-binding"
  roles                 = ["Microsoft.DataProtection/backupVaults/backup-operator"]
  source_resource_id    = module.backup_vault.backup_vault_id

  depends_on = [module.backup_vault]
}

# Required role assignments for AKS backup to function properly
# FIXED: Removed depends_on from inside the for_each map
resource "azurerm_role_assignment" "required_roles" {
  for_each = {
    vault_cluster_reader = {
      role         = "Reader"
      scope        = azurerm_kubernetes_cluster.example.id
      principal_id = module.backup_vault.identity_principal_id
    }
    vault_snap_rg_reader = {
      role         = "Reader"
      scope        = azurerm_resource_group.snap.id
      principal_id = module.backup_vault.identity_principal_id
    }
    vault_snapshot_contributor = {
      role         = "Disk Snapshot Contributor"
      scope        = azurerm_resource_group.snap.id
      principal_id = module.backup_vault.identity_principal_id
    }
    vault_disk_operator = {
      role         = "Data Operator for Managed Disks"
      scope        = azurerm_resource_group.snap.id
      principal_id = module.backup_vault.identity_principal_id
    }
    vault_storage_contributor = {
      role         = "Storage Blob Data Contributor"
      scope        = azurerm_storage_account.example.id
      principal_id = module.backup_vault.identity_principal_id
    }
    cluster_snap_contributor = {
      role         = "Contributor"
      scope        = azurerm_resource_group.snap.id
      principal_id = azurerm_kubernetes_cluster.example.identity[0].principal_id
    }
  }

  principal_id         = each.value.principal_id
  scope                = each.value.scope
  role_definition_name = each.value.role

  # FIXED: Moved depends_on to the resource level instead of inside the for_each map
  depends_on = [time_sleep.wait_for_extension, module.backup_vault]
}

# Wait for role assignments to propagate before creating backup resources
resource "time_sleep" "wait_for_rbac" {
  # Azure RBAC can take time to propagate
  create_duration = "2m"

  depends_on = [
    azurerm_role_assignment.required_roles,
    azurerm_kubernetes_cluster_trusted_access_role_binding.backup_access,
    azurerm_role_assignment.extension_storage_access
  ]
}
```

<!-- markdownlint-disable MD033 -->
## Requirements

The following requirements are needed by this module:

- <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) (>= 1.7.0)

- <a name="requirement_azurerm"></a> [azurerm](#requirement\_azurerm) (>= 3.116.0, < 5.0.0)

- <a name="requirement_time"></a> [time](#requirement\_time) (>= 0.9.1)

## Resources

The following resources are used by this module:

- [azurerm_kubernetes_cluster.example](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/kubernetes_cluster) (resource)
- [azurerm_kubernetes_cluster_extension.backup_extension](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/kubernetes_cluster_extension) (resource)
- [azurerm_kubernetes_cluster_trusted_access_role_binding.backup_access](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/kubernetes_cluster_trusted_access_role_binding) (resource)
- [azurerm_resource_group.example](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) (resource)
- [azurerm_resource_group.snap](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/resource_group) (resource)
- [azurerm_role_assignment.extension_storage_access](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) (resource)
- [azurerm_role_assignment.required_roles](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/role_assignment) (resource)
- [azurerm_storage_account.example](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_account) (resource)
- [azurerm_storage_container.example](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/resources/storage_container) (resource)
- [time_sleep.wait_for_extension](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep) (resource)
- [time_sleep.wait_for_rbac](https://registry.terraform.io/providers/hashicorp/time/latest/docs/resources/sleep) (resource)
- [azurerm_client_config.current](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/data-sources/client_config) (data source)

<!-- markdownlint-disable MD013 -->
## Required Inputs

No required inputs.

## Optional Inputs

No optional inputs.

## Outputs

No outputs.

## Modules

The following Modules are called:

### <a name="module_backup_vault"></a> [backup\_vault](#module\_backup\_vault)

Source: ../../

Version:

### <a name="module_naming"></a> [naming](#module\_naming)

Source: Azure/naming/azurerm

Version: ~> 0.3

<!-- markdownlint-disable-next-line MD041 -->
## Data Collection

The software may collect information about you and your use of the software and send it to Microsoft. Microsoft may use this information to provide services and improve our products and services. You may turn off the telemetry as described in the repository. There are also some features in the software that may enable you and Microsoft to collect data from users of your applications. If you use these features, you must comply with applicable law, including providing appropriate notices to users of your applications together with a copy of Microsoftâ€™s privacy statement. Our privacy statement is located at <https://go.microsoft.com/fwlink/?LinkID=824704>. You can learn more about data collection and use in the help documentation and our privacy statement. Your use of the software operates as your consent to these practices.
<!-- END_TF_DOCS -->